# RSA - Level 3

# See the attachment for the challenge code. The output is:
# [121720186806296997800979538534610838374734751334685912810089377215004504057011542815350249589409126571557756347530275377081347144107627877648585982070305444757428430884386644436796681950522231862132460974829459908011848164947235675260429548827529963885145183776175424511145093559808770680388618014964869201199, 115798264708831001509831452282652377117247913406230481173932971530311207138289505609425951644808355060285770269148892080753105106723888042934884834817949996297119038125679794627407921510845406549274278284300830810036526628513928381076981701488991050846914184755737210682948322006955552194206666221556530254069, 129891916645136766954990840071239136459207498813379400672601426578831847656212739760321974414319624780647238243520795621558507340321036960603641016783930001933214554952892980985719766490723702259591820740126106443296808948516725137803993618809971215369272805623068723219777577178592979685247152887369080213469, 97440042627604058119462166311098928079074460477896227193167136164982689015461458211418231427974720780154163727230020238900390489255635496740913390712432413745693887138227178349326834808464939377520843058378484137633039051861149301719616738305187923502768381441541843160895988360219120088573263132711946135549, 118336797456007073778845583425765727519290931431629708341588136084005536094639394444055480793346537253211044225267352801744305543944594258715651884862219847349035909104973416940104288422933727439470796894321119143142352295983873128834400237669322455310392240839827948103230966843721381138542886809256064478583, 98830801478619438580886979231071793416086374828762996995335166178033453794813501043909349956992551774283648522075968950157876919261226385391203458862082192940317067631456258474770737562985117345952159996038314281257462262391260021194541096637417576244012229535327312563436777296722806384925044244352631380237]
# [20895232551321355357796559134923739063229897004564726534442560232700008579832934464588215412298797749098926607008145809365713546063372794478172028895900292570052597729451835013404932658115272822381857334883139192842405577893328881755205525477692528232932048522246106064845149790024188650659712186587302788822, 27487798811245911704259308821426340722272943834169278939573060705897180221981687550608201257369881749684155124541223818713952131057624098178538068959839121916786988723255740240218509529169521298543759721788383816540422333430292030883380440242469234903193688320192413698212154775026244244196587629215529349439, 122927173440180953444662433474083795911421352764116743651940370614018966430157645895292514403617065522903149995860646654893791607848456961010416154477471279012016689725167398900740981766252818136656875685057173271127364782254020078195020269591458290777871967505852847729147604365960804210570303285847704383838, 44233148033940554518432069693759033772383557137256208049342336728964649128201129418248029048455077888784420944572193219780439638707817230248572975335198314036583478516348610748201061630538604305891410474498186918257941528933343064918770597617988984498416891802978664061022237210655046967332587866256202949892, 93945101865165834651030752141276949991568628433520700392114189816600544396582708855981883777442770327027947418039728898637860073054781023087929128993917266453956464368053124527395745452407733825804653717528957214721157125830092515381862283410183665194322787464290673344883392992558759324619716952152651997162, 22730706116732432827726070874241713593369489580689310920350655818718408738470892188020509332323278263964591696394047978191938035115889175060327324556077501151083828817726795434554236484206095214626725550236661310998674664814342644753736805886350007323393028684328815053810466996924583341348546738433492053843]

# === Attack Overview ===
# - Attack Type: Common-Prime / GCD collision attack across multiple moduli
# - Mathematical Attack
# - Weakness: Shared Common Prime Factors
# - Brief Attack Description:
#     This attack exploits the situation where multiple RSA moduli share
#     common prime factors. By computing the GCD of pairs of moduli,
#     we can find these common factors, allowing us to factor the moduli
#     and recover the plaintexts. This is particularly effective when
#     the same prime factor is used across different RSA keys, which is
#     a known weakness in RSA implementations.

# === Attack Steps ===
#  1. Compute the GCD of all pairs of moduli to find shared prime factors.
#  2. For each pair with gcd > 1, extract the common prime factor p.
#  3. Calculate q = n / p to complete the factorization.
#  4. Compute Euler's totient function φ(n) = (p-1)(q-1).
#  5. Calculate the private exponent d = e⁻¹ mod φ(n).
#  6. Decrypt the corresponding ciphertext using m = c^d mod n.
#  7. Convert the decrypted integer to bytes to reveal the flag.

# === Flag ===
# CRYPTO25{c4cb7375-4e31-4379-ad1a-2a9b2361c592}

import math
from Crypto.Util.number import long_to_bytes

# Challenge-provided values
mods = [
    121720186806296997800979538534610838374734751334685912810089377215004504057011542815350249589409126571557756347530275377081347144107627877648585982070305444757428430884386644436796681950522231862132460974829459908011848164947235675260429548827529963885145183776175424511145093559808770680388618014964869201199,
    115798264708831001509831452282652377117247913406230481173932971530311207138289505609425951644808355060285770269148892080753105106723888042934884834817949996297119038125679794627407921510845406549274278284300830810036526628513928381076981701488991050846914184755737210682948322006955552194206666221556530254069,
    129891916645136766954990840071239136459207498813379400672601426578831847656212739760321974414319624780647238243520795621558507340321036960603641016783930001933214554952892980985719766490723702259591820740126106443296808948516725137803993618809971215369272805623068723219777577178592979685247152887369080213469,
    97440042627604058119462166311098928079074460477896227193167136164982689015461458211418231427974720780154163727230020238900390489255635496740913390712432413745693887138227178349326834808464939377520843058378484137633039051861149301719616738305187923502768381441541843160895988360219120088573263132711946135549,
    118336797456007073778845583425765727519290931431629708341588136084005536094639394444055480793346537253211044225267352801744305543944594258715651884862219847349035909104973416940104288422933727439470796894321119143142352295983873128834400237669322455310392240839827948103230966843721381138542886809256064478583,
    98830801478619438580886979231071793416086374828762996995335166178033453794813501043909349956992551774283648522075968950157876919261226385391203458862082192940317067631456258474770737562985117345952159996038314281257462262391260021194541096637417576244012229535327312563436777296722806384925044244352631380237
]
ciphers = [
    20895232551321355357796559134923739063229897004564726534442560232700008579832934464588215412298797749098926607008145809365713546063372794478172028895900292570052597729451835013404932658115272822381857334883139192842405577893328881755205525477692528232932048522246106064845149790024188650659712186587302788822,
    27487798811245911704259308821426340722272943834169278939573060705897180221981687550608201257369881749684155124541223818713952131057624098178538068959839121916786988723255740240218509529169521298543759721788383816540422333430292030883380440242469234903193688320192413698212154775026244244196587629215529349439,
    122927173440180953444662433474083795911421352764116743651940370614018966430157645895292514403617065522903149995860646654893791607848456961010416154477471279012016689725167398900740981766252818136656875685057173271127364782254020078195020269591458290777871967505852847729147604365960804210570303285847704383838,
    44233148033940554518432069693759033772383557137256208049342336728964649128201129418248029048455077888784420944572193219780439638707817230248572975335198314036583478516348610748201061630538604305891410474498186918257941528933343064918770597617988984498416891802978664061022237210655046967332587866256202949892,
    93945101865165834651030752141276949991568628433520700392114189816600544396582708855981883777442770327027947418039728898637860073054781023087929128993917266453956464368053124527395745452407733825804653717528957214721157125830092515381862283410183665194322787464290673344883392992558759324619716952152651997162,
    22730706116732432827726070874241713593369489580689310920350655818718408738470892188020509332323278263964591696394047978191938035115889175060327324556077501151083828817726795434554236484206095214626725550236661310998674664814342644753736805886350007323393028684328815053810466996924583341348546738433492053843
]
E = 65537

# We use the GCD (Greatest Common Divisor) here to detect if any two RSA moduli share a common prime factor.
# If two moduli have a GCD greater than 1 (but less than either modulus), it means they share a prime factor,
# which is a serious vulnerability in RSA. Once we find this shared prime, we can factor both moduli,
# reconstruct the private keys, and decrypt the ciphertexts. This attack works because reusing a prime across
# different RSA keys breaks the security assumption that factoring the modulus is hard.

def recover_key_and_decrypt(mods, ciphers):
    """
    Factor moduli by exploiting GCD collisions, then decrypt using any recovered key.
    """
    n = len(mods) # Number of moduli = 6
    
    # Map modulus index to its factors
    factors = {}

    # Compute pairwise GCDs to find shared primes
    for i in range(n):
        for j in range(i+1, n):
            g = math.gcd(mods[i], mods[j])
            if 1 < g < mods[i]:
                # g is a prime factor of both mods[i] and mods[j]
                factors[i] = (g, mods[i] // g)
                factors[j] = (g, mods[j] // g)

    if not factors:
        raise ValueError("No shared factors found")

    # Note: I store both factors[i] and factors[j] above, but for the purpose of decrypting
    # a single message, it is sufficient to use just one of them.

    # Use first recovered factorization to decrypt
    idx, (p, q) = next(iter(factors.items()))
    
    # Compute φ(n) = (p-1)*(q-1)
    phi = (p - 1) * (q - 1)
    
    # Compute private exponent d = E^{-1} mod φ(n)
    d = pow(E, -1, phi)
    
    # Decrypt the first ciphertext using the recovered key
    flag_int = pow(ciphers[idx], d, mods[idx])
    
    return long_to_bytes(flag_int)

def main():
    flag = recover_key_and_decrypt(mods, ciphers)
    print(flag.decode())

if __name__ == "__main__":
    main()
